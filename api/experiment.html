

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mozanalysis.experiment &mdash; mozanalysis  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="mozanalysis.frequentist_stats.bootstrap" href="frequentist_stats/bootstrap.html" />
    <link rel="prev" title="mozanalysis.bq" href="bq.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> mozanalysis
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">About Mozanalysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide.html">Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../api.html">API Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="bayesian_stats.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.bayesian_stats</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="bayesian_stats/bayesian_bootstrap.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.bayesian_stats.bayesian_bootstrap</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="bayesian_stats/binary.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.bayesian_stats.binary</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="bayesian_stats/survival_func.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.bayesian_stats.survival_func</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="bq.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.bq</span></code></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.experiment</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="frequentist_stats/bootstrap.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.frequentist_stats.bootstrap</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.metrics</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics/desktop.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.metrics.desktop</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="segments.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.segments</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="segments/desktop.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.segments.desktop</span></code></a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">mozanalysis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../api.html">API Documentation</a> &raquo;</li>
        
      <li><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.experiment</span></code></li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/api/experiment.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="module-mozanalysis.experiment">
<span id="mozanalysis-experiment"></span><h1><a class="reference internal" href="#module-mozanalysis.experiment" title="mozanalysis.experiment"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozanalysis.experiment</span></code></a><a class="headerlink" href="#module-mozanalysis.experiment" title="Permalink to this headline">¶</a></h1>
<dl class="py class">
<dt id="mozanalysis.experiment.Experiment">
<em class="property">class </em><code class="sig-prename descclassname">mozanalysis.experiment.</code><code class="sig-name descname">Experiment</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">experiment_slug</span></em>, <em class="sig-param"><span class="n">start_date</span></em>, <em class="sig-param"><span class="n">num_dates_enrollment</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">app_id</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/mozanalysis/experiment.html#Experiment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#mozanalysis.experiment.Experiment" title="Permalink to this definition">¶</a></dt>
<dd><p>Query experiment data; store experiment metadata.</p>
<p>The methods here query data in a way compatible with the following
principles, which are important for experiment analysis:</p>
<ul class="simple">
<li><p>The population of clients in each branch must have the same
properties, aside from the intervention itself and its
consequences; i.e. there must be no underlying bias in the
branch populations.</p></li>
<li><p>We must measure the same thing for each client, to minimize the
variance associated with our measurement.</p></li>
</ul>
<p>So that our analyses follow these abstract principles, we follow
these rules:</p>
<ul class="simple">
<li><p>Start with a list of all clients who enrolled.</p></li>
<li><p>We can filter this list of clients only based on information known
to us at or before the time that they enrolled, because later
information might be causally connected to the intervention.</p></li>
<li><p>For any given metric, every client gets a non-null value; we don’t
implicitly ignore anyone, even if they churned and stopped
sending data.</p></li>
<li><p>Typically if an enrolled client no longer qualifies for enrollment,
we’ll still want to include their data in the analysis, unless
we’re explicitly using stats methods that handle censored data.</p></li>
<li><p>We define a “analysis window” with respect to clients’
enrollment dates. Each metric only uses data collected inside
this analysis window. We can only analyze data for a client
if we have data covering their entire analysis window.</p></li>
</ul>
<p>Example usage (in a colab notebook):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">auth</span>
<span class="n">auth</span><span class="o">.</span><span class="n">authenticate_user</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Authenticated&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">mozanalysis.experiment</span> <span class="kn">import</span> <span class="n">Experiment</span>
<span class="kn">from</span> <span class="nn">mozanalysis.bq</span> <span class="kn">import</span> <span class="n">BigQueryContext</span>
<span class="kn">from</span> <span class="nn">mozanalysis.metrics.desktop</span> <span class="kn">import</span> <span class="n">active_hours</span><span class="p">,</span> <span class="n">uri_count</span>

<span class="n">bq_context</span> <span class="o">=</span> <span class="n">BigQueryContext</span><span class="p">(</span>
    <span class="n">dataset_id</span><span class="o">=</span><span class="s1">&#39;your-dataset-id&#39;</span><span class="p">,</span>  <span class="c1"># e.g. mine&#39;s flawrence</span>
    <span class="n">project_id</span><span class="o">=</span><span class="s1">&#39;moz-fx-data-bq-data-science&#39;</span>  <span class="c1"># this is the default anyway</span>
<span class="p">)</span>

<span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span>
    <span class="n">experiment_slug</span><span class="o">=</span><span class="s1">&#39;pref-fingerprinting-protections-retention-study-release-70&#39;</span><span class="p">,</span>
    <span class="n">start_date</span><span class="o">=</span><span class="s1">&#39;2019-10-29&#39;</span><span class="p">,</span>
    <span class="n">num_dates_enrollment</span><span class="o">=</span><span class="mi">8</span>
<span class="p">)</span>

<span class="c1"># Run the query and get the results as a DataFrame</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">get_single_window_data</span><span class="p">(</span>
    <span class="n">bq_context</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="n">active_hours</span><span class="p">,</span>
        <span class="n">uri_count</span>
    <span class="p">],</span>
    <span class="n">last_date_full_data</span><span class="o">=</span><span class="s1">&#39;2019-12-01&#39;</span><span class="p">,</span>
    <span class="n">analysis_start_days</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">analysis_length_days</span><span class="o">=</span><span class="mi">7</span>
<span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>experiment_slug</strong> (<em>str</em>) – Name of the study, used to identify
the enrollment events specific to this study.</p></li>
<li><p><strong>start_date</strong> (<em>str</em>) – e.g. ‘2019-01-01’. First date on which enrollment
events were received.</p></li>
<li><p><strong>num_dates_enrollment</strong> (<em>int</em><em>, </em><em>optional</em>) – Only include this many dates
of enrollments. If <code class="docutils literal notranslate"><span class="pre">None</span></code> then use the maximum number of dates
as determined by the metric’s analysis window and
<code class="docutils literal notranslate"><span class="pre">last_date_full_data</span></code>. Typically <code class="docutils literal notranslate"><span class="pre">7n+1</span></code>, e.g. <code class="docutils literal notranslate"><span class="pre">8</span></code>. The
factor ‘7’ removes weekly seasonality, and the <code class="docutils literal notranslate"><span class="pre">+1</span></code> accounts
for the fact that enrollment typically starts a few hours
before UTC midnight.</p></li>
<li><p><strong>app_id</strong> (<em>str</em><em>, </em><em>optional</em>) – For a Glean app, the name of the BigQuery
dataset derived from its app ID, like <cite>org_mozilla_firefox</cite>.</p></li>
</ul>
</dd>
</dl>
<dl class="py attribute">
<dt id="mozanalysis.experiment.Experiment.experiment_slug">
<code class="sig-name descname">experiment_slug</code><a class="headerlink" href="#mozanalysis.experiment.Experiment.experiment_slug" title="Permalink to this definition">¶</a></dt>
<dd><p>Name of the study, used to identify
the enrollment events specific to this study.</p>
<dl class="field-list simple">
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt id="mozanalysis.experiment.Experiment.start_date">
<code class="sig-name descname">start_date</code><a class="headerlink" href="#mozanalysis.experiment.Experiment.start_date" title="Permalink to this definition">¶</a></dt>
<dd><p>e.g. ‘2019-01-01’. First date on which enrollment
events were received.</p>
<dl class="field-list simple">
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt id="mozanalysis.experiment.Experiment.num_dates_enrollment">
<code class="sig-name descname">num_dates_enrollment</code><a class="headerlink" href="#mozanalysis.experiment.Experiment.num_dates_enrollment" title="Permalink to this definition">¶</a></dt>
<dd><p>Only include this many days
of enrollments. If <code class="docutils literal notranslate"><span class="pre">None</span></code> then use the maximum number of days
as determined by the metric’s analysis window and
<code class="docutils literal notranslate"><span class="pre">last_date_full_data</span></code>. Typically <code class="docutils literal notranslate"><span class="pre">7n+1</span></code>, e.g. <code class="docutils literal notranslate"><span class="pre">8</span></code>. The
factor ‘7’ removes weekly seasonality, and the <code class="docutils literal notranslate"><span class="pre">+1</span></code> accounts
for the fact that enrollment typically starts a few hours
before UTC midnight.</p>
<dl class="field-list simple">
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p>int, optional</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="mozanalysis.experiment.Experiment.get_single_window_data">
<code class="sig-name descname">get_single_window_data</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">bq_context</span></em>, <em class="sig-param"><span class="n">metric_list</span></em>, <em class="sig-param"><span class="n">last_date_full_data</span></em>, <em class="sig-param"><span class="n">analysis_start_days</span></em>, <em class="sig-param"><span class="n">analysis_length_days</span></em>, <em class="sig-param"><span class="n">enrollments_query_type</span><span class="o">=</span><span class="default_value">'normandy'</span></em>, <em class="sig-param"><span class="n">custom_enrollments_query</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">segment_list</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/mozanalysis/experiment.html#Experiment.get_single_window_data"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#mozanalysis.experiment.Experiment.get_single_window_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a DataFrame containing per-client metric values.</p>
<p>Also store them in a permanent table in BigQuery. The name of
this table will be printed. Subsequent calls to this function
will simply read the results from this table.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>bq_context</strong> (<a class="reference internal" href="bq.html#mozanalysis.bq.BigQueryContext" title="mozanalysis.bq.BigQueryContext"><em>BigQueryContext</em></a>) – BigQuery configuration and client.</p></li>
<li><p><strong>metric_list</strong> (<em>list of mozanalysis.metric.Metric</em>) – The metrics
to analyze.</p></li>
<li><p><strong>last_date_full_data</strong> (<em>str</em>) – The most recent date for which we
have complete data, e.g. ‘2019-03-22’. If you want to ignore
all data collected after a certain date (e.g. when the
experiment recipe was deactivated), then do that here.</p></li>
<li><p><strong>analysis_start_days</strong> (<em>int</em>) – the start of the analysis window,
measured in ‘days since the client enrolled’. We ignore data
collected outside this analysis window.</p></li>
<li><p><strong>analysis_length_days</strong> (<em>int</em>) – the length of the analysis window,
measured in days.</p></li>
<li><p><strong>enrollments_query_type</strong> (<em>'normandy'</em><em> or </em><em>'fenix-fallback'</em>) – Specifies the query type to use to get the experiment’s
enrollments, unless overridden by
<code class="docutils literal notranslate"><span class="pre">custom_enrollments_query</span></code>.</p></li>
<li><p><strong>custom_enrollments_query</strong> (<em>str</em>) – <p>A full SQL query to be used
in the main query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WITH</span> <span class="n">raw_enrollments</span> <span class="n">AS</span> <span class="p">({</span><span class="n">custom_enrollments_query</span><span class="p">})</span>
</pre></div>
</div>
</p></li>
<li><p><strong>segment_list</strong> (<em>list of mozanalysis.segment.Segment</em>) – The user
segments to study.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A pandas DataFrame of experiment data. One row per <code class="docutils literal notranslate"><span class="pre">client_id</span></code>.
Some metadata columns, then one column per metric in
<code class="docutils literal notranslate"><span class="pre">metric_list</span></code>, and one column per sanity-check metric.
Columns (not necessarily in order):</p>
<blockquote>
<div><ul class="simple">
<li><p>client_id (str): Not necessary for “happy path” analyses.</p></li>
<li><p>branch (str): The client’s branch</p></li>
<li><p>other columns of <code class="docutils literal notranslate"><span class="pre">enrollments</span></code>.</p></li>
<li><p>[metric 1]: The client’s value for the first metric in
<code class="docutils literal notranslate"><span class="pre">metric_list</span></code>.</p></li>
<li><p>…</p></li>
<li><p>[metric n]: The client’s value for the nth (final)
metric in <code class="docutils literal notranslate"><span class="pre">metric_list</span></code>.</p></li>
<li><p>[sanity check 1]: The client’s value for the first
sanity check metric for the first data source that
supports sanity checks.</p></li>
<li><p>…</p></li>
<li><p>[sanity check n]: The client’s value for the last
sanity check metric for the last data source that
supports sanity checks.</p></li>
</ul>
</div></blockquote>
<p>This format - the schema plus there being one row per
enrolled client, regardless of whether the client has data
in <code class="docutils literal notranslate"><span class="pre">data_source</span></code> - was agreed upon by the DS team, and is the
standard format for queried experimental data.</p>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="mozanalysis.experiment.Experiment.get_time_series_data">
<code class="sig-name descname">get_time_series_data</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">bq_context</span></em>, <em class="sig-param"><span class="n">metric_list</span></em>, <em class="sig-param"><span class="n">last_date_full_data</span></em>, <em class="sig-param"><span class="n">time_series_period</span><span class="o">=</span><span class="default_value">'weekly'</span></em>, <em class="sig-param"><span class="n">enrollments_query_type</span><span class="o">=</span><span class="default_value">'normandy'</span></em>, <em class="sig-param"><span class="n">custom_enrollments_query</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">segment_list</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/mozanalysis/experiment.html#Experiment.get_time_series_data"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#mozanalysis.experiment.Experiment.get_time_series_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a TimeSeriesResult with per-client metric values.</p>
<p>Roughly equivalent to looping over <a class="reference internal" href="#mozanalysis.experiment.Experiment.get_single_window_data" title="mozanalysis.experiment.Experiment.get_single_window_data"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_single_window_data()</span></code></a>
with different analysis windows, and reorganising the results.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>bq_context</strong> (<a class="reference internal" href="bq.html#mozanalysis.bq.BigQueryContext" title="mozanalysis.bq.BigQueryContext"><em>BigQueryContext</em></a>) – BigQuery configuration and client.</p></li>
<li><p><strong>metric_list</strong> (<em>list of mozanalysis.metric.Metric</em>) – The metrics to analyze.</p></li>
<li><p><strong>last_date_full_data</strong> (<em>str</em>) – The most recent date for which we
have complete data, e.g. ‘2019-03-22’. If you want to ignore
all data collected after a certain date (e.g. when the
experiment recipe was deactivated), then do that here.</p></li>
<li><p><strong>time_series_period</strong> (<em>'daily'</em><em> or </em><em>'weekly'</em>) – How long each
analysis window should be.</p></li>
<li><p><strong>enrollments_query_type</strong> (<em>'normandy'</em><em> or </em><em>'fenix-fallback'</em>) – Specifies the query type to use to get the experiment’s
enrollments, unless overridden by
<code class="docutils literal notranslate"><span class="pre">custom_enrollments_query</span></code>.</p></li>
<li><p><strong>custom_enrollments_query</strong> (<em>str</em>) – <p>A full SQL query to be used
in the main query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WITH</span> <span class="n">raw_enrollments</span> <span class="n">AS</span> <span class="p">({</span><span class="n">custom_enrollments_query</span><span class="p">})</span>
</pre></div>
</div>
</p></li>
<li><p><strong>segment_list</strong> (<em>list of mozanalysis.segment.Segment</em>) – The user
segments to study.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A <a class="reference internal" href="#mozanalysis.experiment.TimeSeriesResult" title="mozanalysis.experiment.TimeSeriesResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">mozanalysis.experiment.TimeSeriesResult</span></code></a> object,
which may be used to obtain a
pandas DataFrame of per-client metric data, for each
analysis window. Each DataFrame is a pandas DataFrame in
“the standard format”: one row per client, some metadata
columns, plus one column per metric and sanity-check metric.
Its columns (not necessarily in order):</p>
<blockquote>
<div><ul class="simple">
<li><p>branch (str): The client’s branch</p></li>
<li><p>other columns of <code class="docutils literal notranslate"><span class="pre">enrollments</span></code>.</p></li>
<li><p>[metric 1]: The client’s value for the first metric in
<code class="docutils literal notranslate"><span class="pre">metric_list</span></code>.</p></li>
<li><p>…</p></li>
<li><p>[metric n]: The client’s value for the nth (final)
metric in <code class="docutils literal notranslate"><span class="pre">metric_list</span></code>.</p></li>
<li><p>[sanity check 1]: The client’s value for the first
sanity check metric for the first data source that
supports sanity checks.</p></li>
<li><p>…</p></li>
<li><p>[sanity check n]: The client’s value for the last
sanity check metric for the last data source that
supports sanity checks.</p></li>
</ul>
</div></blockquote>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="mozanalysis.experiment.Experiment.build_enrollments_query">
<code class="sig-name descname">build_enrollments_query</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">time_limits</span></em>, <em class="sig-param"><span class="n">enrollments_query_type</span><span class="o">=</span><span class="default_value">'normandy'</span></em>, <em class="sig-param"><span class="n">custom_enrollments_query</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">segment_list</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span> &#x2192; str<a class="reference internal" href="../_modules/mozanalysis/experiment.html#Experiment.build_enrollments_query"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#mozanalysis.experiment.Experiment.build_enrollments_query" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a SQL query for querying enrollments data.</p>
<p>For interactive use, prefer <a class="reference internal" href="#mozanalysis.experiment.Experiment.get_time_series_data" title="mozanalysis.experiment.Experiment.get_time_series_data"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_time_series_data()</span></code></a> or
<a class="reference internal" href="#mozanalysis.experiment.Experiment.get_single_window_data" title="mozanalysis.experiment.Experiment.get_single_window_data"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_single_window_data()</span></code></a>, according to your use case,
which will run the query for you and return a materialized
dataframe.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>time_limits</strong> (<a class="reference internal" href="#mozanalysis.experiment.TimeLimits" title="mozanalysis.experiment.TimeLimits"><em>TimeLimits</em></a>) – An object describing the
interval(s) to query</p></li>
<li><p><strong>enrollments_query_type</strong> (<em>'normandy'</em><em> or </em><em>'fenix-fallback'</em>) – Specifies the query type to use to get the experiment’s
enrollments, unless overridden by
<code class="docutils literal notranslate"><span class="pre">custom_enrollments_query</span></code>.</p></li>
<li><p><strong>custom_enrollments_query</strong> (<em>str</em>) – <p>A full SQL query to be used
in the main query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WITH</span> <span class="n">raw_enrollments</span> <span class="n">AS</span> <span class="p">({</span><span class="n">custom_enrollments_query</span><span class="p">})</span>
</pre></div>
</div>
</p></li>
<li><p><strong>segment_list</strong> (<em>list of mozanalysis.segment.Segment</em>) – The user
segments to study.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A string containing a BigQuery SQL expression.</p>
</dd>
</dl>
<p>Building this query is the main goal of this module.</p>
</dd></dl>

<dl class="py method">
<dt id="mozanalysis.experiment.Experiment.build_metrics_query">
<code class="sig-name descname">build_metrics_query</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">metric_list</span></em>, <em class="sig-param"><span class="n">time_limits</span></em>, <em class="sig-param"><span class="n">enrollments_table</span></em><span class="sig-paren">)</span> &#x2192; str<a class="reference internal" href="../_modules/mozanalysis/experiment.html#Experiment.build_metrics_query"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#mozanalysis.experiment.Experiment.build_metrics_query" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a SQL query for querying metric data.</p>
<p>For interactive use, prefer <a class="reference internal" href="#mozanalysis.experiment.Experiment.get_time_series_data" title="mozanalysis.experiment.Experiment.get_time_series_data"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_time_series_data()</span></code></a> or
<a class="reference internal" href="#mozanalysis.experiment.Experiment.get_single_window_data" title="mozanalysis.experiment.Experiment.get_single_window_data"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_single_window_data()</span></code></a>, according to your use case,
which will run the query for you and return a materialized
dataframe.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>metric_list</strong> (<em>list of mozanalysis.metric.Metric</em>) – The metrics to analyze.</p></li>
<li><p><strong>time_limits</strong> (<a class="reference internal" href="#mozanalysis.experiment.TimeLimits" title="mozanalysis.experiment.TimeLimits"><em>TimeLimits</em></a>) – An object describing the
interval(s) to query</p></li>
<li><p><strong>enrollments_table</strong> (<em>str</em>) – The name of the enrollments table</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A string containing a BigQuery SQL expression.</p>
</dd>
</dl>
<p>Building this query is the main goal of this module.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="mozanalysis.experiment.TimeLimits">
<em class="property">class </em><code class="sig-prename descclassname">mozanalysis.experiment.</code><code class="sig-name descname">TimeLimits</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">first_enrollment_date</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">last_enrollment_date</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">first_date_data_required</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">last_date_data_required</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">analysis_windows</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/mozanalysis/experiment.html#TimeLimits"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#mozanalysis.experiment.TimeLimits" title="Permalink to this definition">¶</a></dt>
<dd><p>Expresses time limits for different kinds of analysis windows.</p>
<p>Instantiated and used by the <a class="reference internal" href="#mozanalysis.experiment.Experiment" title="mozanalysis.experiment.Experiment"><code class="xref py py-class docutils literal notranslate"><span class="pre">Experiment</span></code></a> class; end users
should not need to interact with it.</p>
<p>Do not directly instantiate: use the constructors provided.</p>
<p>There are several time constraints needed to specify a valid query
for experiment data:</p>
<blockquote>
<div><ul class="simple">
<li><p>When did enrollments start?</p></li>
<li><p>When did enrollments stop?</p></li>
<li><p>How long after enrollment does the analysis window start?</p></li>
<li><p>How long is the analysis window?</p></li>
</ul>
</div></blockquote>
<p>Even if these four quantities are specified directly, it is
important to check that they are consistent with the available
data - i.e. that we have data for the entire analysis window for
every enrollment.</p>
<p>Furthermore, there are some extra quantities that are useful for
writing efficient queries:</p>
<blockquote>
<div><ul class="simple">
<li><p>What is the first date for which we need data from our data
source?</p></li>
<li><p>What is the last date for which we need data from our data
source?</p></li>
</ul>
</div></blockquote>
<p>Instances of this class store all these quantities and do validation
to make sure that they’re consistent. The “store lots of overlapping
state and validate” strategy was chosen over “store minimal state
and compute on the fly” because different state is supplied in
different contexts.</p>
<dl class="py method">
<dt id="mozanalysis.experiment.TimeLimits.for_single_analysis_window">
<em class="property">classmethod </em><code class="sig-name descname">for_single_analysis_window</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">first_enrollment_date</span></em>, <em class="sig-param"><span class="n">last_date_full_data</span></em>, <em class="sig-param"><span class="n">analysis_start_days</span></em>, <em class="sig-param"><span class="n">analysis_length_dates</span></em>, <em class="sig-param"><span class="n">num_dates_enrollment</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/mozanalysis/experiment.html#TimeLimits.for_single_analysis_window"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#mozanalysis.experiment.TimeLimits.for_single_analysis_window" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a <code class="docutils literal notranslate"><span class="pre">TimeLimits</span></code> instance with the following parameters</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>first_enrollment_date</strong> (<em>str</em>) – First date on which enrollment
events were received; the start date of the experiment.</p></li>
<li><p><strong>last_date_full_data</strong> (<em>str</em>) – The most recent date for which we
have complete data, e.g. ‘2019-03-22’. If you want to ignore
all data collected after a certain date (e.g. when the
experiment recipe was deactivated), then do that here.</p></li>
<li><p><strong>analysis_start_days</strong> (<em>int</em>) – the start of the analysis window,
measured in ‘days since the client enrolled’. We ignore data
collected outside this analysis window.</p></li>
<li><p><strong>analysis_length_days</strong> (<em>int</em>) – the length of the analysis window,
measured in days.</p></li>
<li><p><strong>num_dates_enrollment</strong> (<em>int</em><em>, </em><em>optional</em>) – Only include this many days
of enrollments. If <code class="docutils literal notranslate"><span class="pre">None</span></code> then use the maximum number of days
as determined by the metric’s analysis window and
<code class="docutils literal notranslate"><span class="pre">last_date_full_data</span></code>. Typically <code class="docutils literal notranslate"><span class="pre">7n+1</span></code>, e.g. <code class="docutils literal notranslate"><span class="pre">8</span></code>. The
factor <code class="docutils literal notranslate"><span class="pre">7</span></code> removes weekly seasonality, and the <code class="docutils literal notranslate"><span class="pre">+1</span></code>
accounts for the fact that enrollment typically starts a few
hours before UTC midnight.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="mozanalysis.experiment.TimeLimits.for_ts">
<em class="property">classmethod </em><code class="sig-name descname">for_ts</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">first_enrollment_date</span></em>, <em class="sig-param"><span class="n">last_date_full_data</span></em>, <em class="sig-param"><span class="n">time_series_period</span></em>, <em class="sig-param"><span class="n">num_dates_enrollment</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/mozanalysis/experiment.html#TimeLimits.for_ts"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#mozanalysis.experiment.TimeLimits.for_ts" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a <code class="docutils literal notranslate"><span class="pre">TimeLimits</span></code> instance for a time series.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>first_enrollment_date</strong> (<em>str</em>) – First date on which enrollment
events were received; the start date of the experiment.</p></li>
<li><p><strong>last_date_full_data</strong> (<em>str</em>) – The most recent date for which we
have complete data, e.g. ‘2019-03-22’. If you want to ignore
all data collected after a certain date (e.g. when the
experiment recipe was deactivated), then do that here.</p></li>
<li><p><strong>time_series_period</strong> – ‘daily’ or ‘weekly’.</p></li>
<li><p><strong>num_dates_enrollment</strong> (<em>int</em>) – Take this many days of client
enrollments. This is a mandatory argument because it
determines the number of points in the time series.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="mozanalysis.experiment.AnalysisWindow">
<em class="property">class </em><code class="sig-prename descclassname">mozanalysis.experiment.</code><code class="sig-name descname">AnalysisWindow</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">start</span><span class="p">:</span> <span class="n">int</span></em>, <em class="sig-param"><span class="n">end</span><span class="p">:</span> <span class="n">int</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/mozanalysis/experiment.html#AnalysisWindow"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#mozanalysis.experiment.AnalysisWindow" title="Permalink to this definition">¶</a></dt>
<dd><p>Represents the range of days in which to measure a metric.</p>
<p>The range is measured in “days after enrollment”, and is inclusive.</p>
<p>For example, <code class="docutils literal notranslate"><span class="pre">AnalysisWindow(0,</span> <span class="pre">6)</span></code> is the first week after enrollment.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>start</strong> (<em>int</em>) – First day of the analysis window, in days since
enrollment.</p></li>
<li><p><strong>end</strong> (<em>int</em>) – Final day of the analysis window, in days since
enrollment.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt id="mozanalysis.experiment.TimeSeriesResult">
<em class="property">class </em><code class="sig-prename descclassname">mozanalysis.experiment.</code><code class="sig-name descname">TimeSeriesResult</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">fully_qualified_table_name</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">analysis_windows</span><span class="p">:</span> <span class="n">list</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/mozanalysis/experiment.html#TimeSeriesResult"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#mozanalysis.experiment.TimeSeriesResult" title="Permalink to this definition">¶</a></dt>
<dd><p>Result from a time series query.</p>
<p>For each analysis window, this object lets us get a dataframe in
“the standard format” (one row per client).</p>
<p>Example usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">result_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">time_series_result</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">bq_context</span><span class="p">))</span>
<span class="n">window_0</span> <span class="o">=</span> <span class="n">result_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">window_0</span></code> would then be a pandas DataFrame of results for the
analysis window starting at day 0. <code class="docutils literal notranslate"><span class="pre">result_dict</span></code> would be a
dictionary of all such DataFrames, keyed by the start days of
their analysis windows.</p>
<p>Or, to load only one analysis window into RAM:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">window_0</span> <span class="o">=</span> <span class="n">time_series_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bq_context</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<dl class="py method">
<dt id="mozanalysis.experiment.TimeSeriesResult.get">
<code class="sig-name descname">get</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">bq_context</span></em>, <em class="sig-param"><span class="n">analysis_window</span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/mozanalysis/experiment.html#TimeSeriesResult.get"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#mozanalysis.experiment.TimeSeriesResult.get" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the DataFrame for a specific analysis window.</p>
<p>N.B. this makes a BigQuery query each time it is run; caching
results is your responsibility.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>bq_context</strong> (<a class="reference internal" href="bq.html#mozanalysis.bq.BigQueryContext" title="mozanalysis.bq.BigQueryContext"><em>BigQueryContext</em></a>) – </p></li>
<li><p><strong>analysis_window</strong> (<a class="reference internal" href="#mozanalysis.experiment.AnalysisWindow" title="mozanalysis.experiment.AnalysisWindow"><em>AnalysisWindow</em></a><em> or </em><em>int</em>) – The analysis
window, or its start day as an int.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="frequentist_stats/bootstrap.html" class="btn btn-neutral float-right" title="mozanalysis.frequentist_stats.bootstrap" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="bq.html" class="btn btn-neutral float-left" title="mozanalysis.bq" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Mozilla

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>